{% extends 'bootstrap_base.html' %}
{% block title %}Pedido {{ pedido.id }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Pedido #{{ pedido.id }}</h3>
  <div class="d-flex gap-2">
    {% set session_user = session.get('user') %}
    {% if pedido.status == 'Pendente' and session_user and session_user.get('role') in ['approver', 'admin'] %}
      <button id="btn-approve" class="btn btn-success">Aprovar</button>
    {% endif %}
    {% if pedido.arquivo_excel %}
      <a class="btn btn-outline-primary" href="{{ url_for('download_pedido', pedido_id=pedido.id) }}">
        Baixar
      </a>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <p><strong>Fornecedor:</strong> {{ pedido.fornecedor }}</p>
    <p><strong>Status:</strong> {{ pedido.status }}</p>
    <p><strong>Criado por:</strong> {{ pedido.created_by or '-' }}</p>
    <h5 class="mt-4">Itens</h5>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Qtd</th>
          <th>Codigo</th>
          <th>Descricao</th>
          <th>Valor</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in pedido.itens %}
          <tr>
            <td>{{ it.quantidade }}</td>
            <td>{{ it.codigo }}</td>
            <td>{{ it.descricao }}</td>
            <td>{{ '%.2f'|format(it.valor) }}</td>
            <td>{{ '%.2f'|format(it.quantidade * it.valor) }}</td>
          </tr>
        {% endfor %}
        {% if not pedido.itens %}
          <tr>
            <td colspan="5" class="text-center text-muted">Nenhum item informado</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% if pedido.itens %}
  <p><strong>Total do pedido:</strong>
    {{ '%.2f'|format(pedido.itens|sum(attribute='total')) }}</p>
{% endif %}

{% endblock %}

{% block scripts %}
{% if pedido.status == 'Pendente' %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('btn-approve');
    if (!btn) {
      return;
    }
    btn.addEventListener('click', async function () {
      btn.disabled = true;
      try {
        const resp = await fetch('{{ url_for("api_pedido_approve", pedido_id=pedido.id) }}', { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || 'Falha ao aprovar pedido');
        }
        window.location.reload();
      } catch (error) {
        alert(error.message);
        btn.disabled = false;
      }
    });
  });
</script>
{% endif %}
{% endblock %}
